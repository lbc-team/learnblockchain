---
title: ECDH秘钥协商算法原理
permalink: ecdh
date: 2019-06-23 10:48:34
categories: 基础理论
tags:
  - ECDH
  - 安全
  - 密码学
author: 清源
---


`ECDH`全称是椭圆曲线迪菲-赫尔曼秘钥交换（Elliptic Curve Diffie–Hellman key Exchange），主要是用来在一个不安全的通道中建立起安全的共有加密资料，一般来说交换的都是`私钥`，这个密钥一般作为“对称加密”的密钥而被双方在后续数据传输中使用。

<!--more -->

## 算法流程

  我们通过一个经典的场景，Alice和Bob要在一条不安全的线路上交换秘钥，交换的秘钥不能被中间人知晓。
  首先，双方约定使用`ECDH`秘钥交换算法，这个时候双方也知道了`ECDH`算法里的一个大素数`P`，这个`P`可以看做是一个算法中的常量。

> `P`的位数决定了攻击者破解的难度

  还有一个整数`g`用来辅助整个秘钥交换，`g`不用很大，一般是2或者5，双方知道`g`和`p`之后就开始了`ECDH`交换秘钥的过程了。

------

  Alice知道了共用参数`p`和`g`，生成私有整数`a`作为私钥，公钥算法一般是公钥加密，私钥解密，公钥给对方来加密数据，拿到密文后私钥解密查看内容正确性，这个时候Alice直接通过线路告诉Bob自己的私钥`a`显然既不合理也是一件风险很大的事。

  这个时候Alice需要利用`p`，`g`，`a`通过公式`g^a mod p = A`生成A作为公钥传递。

------

   Bob通过链路收到Alice发来的`p`，`g`，`A`，知道了Alice的公钥`A`。这个时候Bob也生成自己的私钥`b`，然后通过公式`g^b mod p = B`生成自己公钥`B`。
   在发送公钥`B`前，Bob通过`A^b mod p = K`生成K作为公共秘钥，但是并不发送给Alice，只通过链路发送`B`。

------

   Alice收到Bob发来的公钥`B`以后，同样通过`B^a mod p = K`生成公共秘钥K，这样Alice和Bob就通过不传递私钥`a`和`b`完成了对公共秘钥K的协商。

## 例子

我们通过代入具体的数字来重复一下上面的过程：

  1. Alice和Bob同意使用质数p和整数g：
    ```
     p = 83, g = 8
    ```
    
  2. Alice选择秘钥 a = 9, 生成公钥 g^a mod p = A 并发送
    ```
     (8^9) mod 83 = 5
    ```  

  3. Bob选择秘钥 b = 21, 生成公钥 A^b mod p = K 并发送
    ```
     (8^21) mod 83 = 18
    ```
    
  4. Alice计算 B^a mod p = K
    ```
     18^9 mod 83 = 24
    ```
    
  5. Bob计算 B^a mod p = K
    ```
     5^21 mod 83 = 24
    ```
  
至此`24`就是双方协商出来的秘钥。


## 协议所面临的问题


由于 ECDH 密钥交换协议不验证公钥发送者的身份，因此无法阻止中间人攻击。如果监听者 Mallory 截获了 Alice 的公钥，就可以替换为他自己的公钥，并将其发送给 Bob。Mallory 还可以截获 Bob 的公钥，替换为他自己的公钥，并将其发送给 Alice。这样，Mallory 就可以轻松地对 Alice 与 Bob 之间发送的任何消息进行解密。他可以更改消息，用他自己的密钥对消息重新加密，然后将消息发送给接收者。

为了解决此问题，Alice 和 Bob 可以在交换公钥之前使用[数字签名](https://learnblockchain.cn/2019/0717/ca/)对公钥进行签名。有两种方法可以实现此目的：

- 用安全的媒体（例如语音通信或可信载运商）在双方之间传输数字签名密钥。
- 使用[公共证书颁发机构 (CA)](https://learnblockchain.cn/2019/0717/ca/) 向双方提供可信数字签名密钥。

## 区块链中的应用场景

  当多个参与方共享同一个链路的时候，联盟链各参与方想要在同一个链路上实现通性的隔离，使用`ECDH`算法既可以实现TCP链接的复用，避免频繁建立大量链接，又可以保证同一链接间的通信隔离。

  各参与方的身份在加入网络前已经有MSP（Membership Service Provider）来颁发验证过，这样就可以规避`ECDH`协议的缺陷。


本文作者是深入浅出区块链共建者清源，欢迎关注清源的[博客](http://qyuan.top)，不定期分享一些区块链底层技术文章。


[深入浅出区块链](https://learnblockchain.cn/) - 打造高质量区块链技术博客，[学区块链](https://learnblockchain.cn/2018/01/11/guide/)都来这里，关注[知乎](https://www.zhihu.com/people/xiong-li-bing/activities)、[微博](https://weibo.com/517623789)。
